#!/bin/bash 

##==============================================================================
##
## Resolve version:
##
##==============================================================================

major=`cut -d "." -f1 ./VERSION`
minor=`cut -d "." -f2 ./VERSION`
revision=`cut -d "." -f3 ./VERSION`
version=${major}.${minor}.${revision}

##==============================================================================
##
## default_prefix:
##
##==============================================================================

#default_prefix=/opt/openenclave-${version}
default_prefix=/opt/microsoft/openenclave

##==============================================================================
##
## Process command-line options:
##
##==============================================================================

for opt
do

  arg=`expr "x$opt" : 'x[^=]*=\(.*\)'`

  case $opt in

    -h | --help)
      help=1
      ;;

    --prefix=*)
      prefix=$arg 
      ;;

    --libdirdir=*)
      libdirdir=$arg 
      ;;

    --bindir=*)
      bindir=$arg 
      ;;

    --includedir=*)
      includedir=$arg 
      ;;

    --datadir=*)
      datadir=$arg 
      ;;

    --enable-werror)
      enable_werror=1
      ;;

    *)
      echo "$0: unknown option:  $opt"
      exit 1
      ;;

  esac

done

##==============================================================================
##
## Resolve install locations:
##
##==============================================================================

if [ -z "${prefix}" ]; then
    prefix=${default_prefix}
fi

if [ -z "${libdir}" ]; then
    libdir=${prefix}/lib
fi

if [ -z "${bindir}" ]; then
    bindir=${prefix}/bin
fi

if [ -z "${includedir}" ]; then
    includedir=${prefix}/include
fi

if [ -z "${datadir}" ]; then
    datadir=${prefix}/share
fi

##==============================================================================
##
## help:
##
##==============================================================================

if [ "$help" = "1" ]; then
    cat<<EOF

OVERVIEW:

Type the following commands to build OpenEnclave:

    $ ./configure
    $ make

OPTIONS:
    -h, --help              Print this help message.
    --prefix=PATH           The installation prefix [${default_prefix}].
    --libdir=PATH           Install libraries here [${default_prefix}/lib].
    --bindir=PATH           Install programs here [${default_prefix}/bin].
    --includedir=PATH       Install includes here [${default_prefix}/include].
    --datadir=PATH          Install data files [${default_prefix}/share].

EOF
    exit 0
fi

##==============================================================================
##
## Resolve target:
##
##==============================================================================

__m=`uname -m 2>/dev/null` || __m=unknown
__s=`uname -s 2>/dev/null`  || __s=unknown
__r=`uname -r 2>/dev/null` || __r=unknown
__v=`grep "^ID=" /etc/os-release | cut -d "=" -f2 | sed "s/\"//g"`

if [ ! -f "/etc/os-release" ]; then
    echo "$0: file not found: /etc/os-release"
    exit 1
fi

case "$__m:$__s:$__r:$__v" in
    x86_64:Linux:*:ubuntu)
        arch=${__m}
        distro=ubuntu
        os=linux
        compiler=gnu
        ;;
    x86_64:Linux:*:centos)
        arch=${__m}
        distro=centos
        os=linux
        compiler=gnu
        ;;
    x86_64:Linux:*:rhel)
        arch=${__m}
        distro=redhat
        os=linux
        compiler=gnu
        ;;
    x86_64:Linux:*:sles)
        arch=${__m}
        distro=sles
        os=linux
        compiler=gnu
        ;;
    *)
        echo "$0: error: unsupported platform: $__m:$__s:$__r:$__v"
        exit 1
        ;;
esac

target="${arch}-${distro}-${os}-${compiler}"

##==============================================================================
##
## Resolve locations:
##
##==============================================================================

if [ -z "$prefix" ]; then
    prefix=/opt/openenclave-$version
fi

if [ -z "$libdir" ]; then
    libdir=$prefix/lib
fi

if [ -z "$bindir" ]; then
    bindir=$prefix/bin
fi

if [ -z "$includedir" ]; then
    includedir=$prefix/include
fi

##==============================================================================
##
## Print failed message and exit
##
##==============================================================================

configure_failed()
{
    echo "$0: failed"
    echo ""
    exit 1
}

##==============================================================================
##
## Check for presence and operability of gcc:
##
##==============================================================================

check_gcc()
{
    echo -n "checking for gcc..."

    gcc=`which gcc 2> /dev/null`

    if [ ! -x "${gcc}" ]; then
        echo "no"
        configure_failed
    fi

    local tempname=`/bin/mktemp`

    echo "int main() { return 0; }" >> ${tempname}.c
    ${gcc} -o ${tempname} ${tempname}.c 2> /dev/null > /dev/null

    if [ "$?" != "0" ]; then
        rm -f ${tempname}.c ${tempname}
        echo "no"
        configure_failed
    fi

    rm -f ${tempname}.c ${tempname}
    echo "yes"
}

check_gcc

##==============================================================================
##
## Check for presence of make:
##
##==============================================================================

check_make()
{
    echo -n "checking for make..."

    make=`which make 2> /dev/null`

    if [ ! -x "${make}" ]; then
        echo "no"
        configure_failed
    fi

    echo "yes"
}

check_make

##==============================================================================
##
## Generate .config:
##
##==============================================================================

rm -rf .config
echo "OE_CONFIGURED=1" >> .config
echo "OE_DISTRONAME=${distro}" >> .config
echo "OE_MAJOR=${major}" >> .config
echo "OE_MINOR=${minor}" >> .config
echo "OE_REVISION=${revision}" >> .config
echo "OE_VERSION=${version}" >> .config
echo "OE_PREFIX=${prefix}" >> .config
echo "OE_LIBDIR=${libdir}" >> .config
echo "OE_BINDIR=${bindir}" >> .config
echo "OE_DATADIR=${datadir}" >> .config
echo "OE_INCLUDEDIR=${includedir}" >> .config

##==============================================================================
##
## Print configured message:
##
##==============================================================================

echo
echo "Configured for ${target}"
echo
